<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- optimized meta tag -->
  <meta name="viewport" content="user-scalable=0, width=device-width, initial-scale=1.0,  minimum-scale=1.0, maximum-scale=1.0">
 
  <title> LE Tag Code Pack - Web Messaging</title>
  <link rel="stylesheet" type="text/css" href="style.css">

 <!-- le-mtagconfig.js must be called from every page. Please update src accordingly -->
  
<!-- BEGIN LivePerson Monitor. -->
<script type="text/javascript">window.lpTag=window.lpTag||{},'undefined'==typeof window.lpTag._tagCount?(window.lpTag={wl:lpTag.wl||null,scp:lpTag.scp||null,site:'15531115'||'',section:lpTag.section||'',tagletSection:lpTag.tagletSection||null,autoStart:false,ovr:lpTag.ovr||{},_v:'1.10.0',_tagCount:1,protocol:'https:',events:{bind:function(t,e,i){lpTag.defer(function(){lpTag.events.bind(t,e,i)},0)},trigger:function(t,e,i){lpTag.defer(function(){lpTag.events.trigger(t,e,i)},1)}},defer:function(t,e){0===e?(this._defB=this._defB||[],this._defB.push(t)):1===e?(this._defT=this._defT||[],this._defT.push(t)):(this._defL=this._defL||[],this._defL.push(t))},load:function(t,e,i){var n=this;setTimeout(function(){n._load(t,e,i)},0)},_load:function(t,e,i){var n=t;t||(n=this.protocol+'//'+(this.ovr&&this.ovr.domain?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site);var o=document.createElement('script');o.setAttribute('charset',e?e:'UTF-8'),i&&o.setAttribute('id',i),o.setAttribute('src',n),document.getElementsByTagName('head').item(0).appendChild(o)},init:function(){this._timing=this._timing||{},this._timing.start=(new Date).getTime();var t=this;window.attachEvent?window.attachEvent('onload',function(){t._domReady('domReady')}):(window.addEventListener('DOMContentLoaded',function(){t._domReady('contReady')},!1),window.addEventListener('load',function(){t._domReady('domReady')},!1)),'undefined'===typeof window._lptStop&&this.load()},start:function(){this.autoStart=!0},_domReady:function(t){this.isDom||(this.isDom=!0,this.events.trigger('LPT','DOM_READY',{t:t})),this._timing[t]=(new Date).getTime()},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],identities:lpTag.identities||[],ev:lpTag.ev||[]},lpTag.init()):window.lpTag._tagCount+=1;</script>
<!-- END LivePerson Monitor. -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script type="text/javascript">
      
    lpTag.autoStart = false;
  


    function deParam(str) {
      return (str || document.location.search).replace(/(^\?)/,'').split("&").map(function(n){return n = n.split("="),this[n[0]] = n[1],this}.bind({}))[0];
    }
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),results = regex.exec(url);
      if (!results) 
        return null;
      if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

   var cnf = {
      redirectURI: document.location.href,//.replace('web-messaging-login-page.html', 'web-messaging-bank-portal.html'),
      authURI: "https://dev-xp3j4tvq.auth0.com/authorize",
      clientID: "l6EYVwVr2Doauy0ixv6fMHrTeEFwkAGX",
      connection: "Username-Password-Authentication",
      grantType: "password",
      nonce: "LiveEngage",
      scope: "openid",
      responseType: "id_token" // responseType:"code" for codeflow/ id_token 
    };

    // var hashParam = deParam(window.location.hash.substr(1));    //comment for codeflow
    // var idtoken = hashParam.id_token;
    var code = getParameterByName('code'); //uncomment for codeflow
   console.log("code   : " + code); 
    
    var counti = 0
   window.lpGetAuthenticationToken = function (callback) {
    // console.log(`counti: ${counti}`)
    // counti = counti + 1;
    // console.log(`counti: ${counti}`)
    // callback({}, 'some error'); 
    // callback({ssoKey: "sometoken", redirect_uri: "http://localhost/load"})    

    if(typeof code === 'undefined' || code === null){
        console.log('id token undefined');

        if(document.location.href.indexOf('web-messaging-bank-portal-code.html')) {
          document.location = document.location.href.replace('web-messaging-bank-portal-code.html', 'web-messaging-login-page-code.html');
        }
        // lpLoginUser();
    } else {
      console.log("Got notification from the cb redirect tab: " + code);
      //console.log("Got notification from the cb redirect tab: " + idtoken);
      var payload = {
        ssoKey: code, // code (AuthKey) in Code Flow
        redirect_uri: document.location.href
      };

          // NOTE: requires the addition of the following added to the 'lpUnifiedWindow' taglet configuration in Houston.
          /*
            [
                {
                    "id": "useOAuth2Standard",
                    "value": "true"
                }
            ]
          */
          
          //var payload =idtoken;
          console.log('payload: ' + JSON.stringify(payload));
          var error;


          if(error !== undefined) {
              callback(payload, error); //????????????????
          } else {
              callback(payload);
          }
        }
    };

    window.lpLogoutUser = function() {
      document.location = document.location.href.replace('web-messaging-bank-portal.html', 'web-messaging-login-page.html');
    };

 // Start Tag or not...
 $(document).ready(function() {
    
    //if(typeof idtoken !== 'undefined'){
    if(typeof code !== 'undefined'){  
      // Logged in with Token
      console.log("have id_token/code");
      document.getElementById("idToken").value = code;



      // function identityFn(callback) {
      //     console.log('inside identityFn');
      //     console.log(callback);
      //     callback({
      //         iss: "https://dev-xp3j4tvq.auth0.com/", //"https://abc-izkao4-v.au.lol.com/", //claims.iss, //issuer
      //         acr: "loa1", //
      //         sub: "auth0|601123bd29fe4800694032c1"//"xxxxxxx" //claims.sub //user-id
      //     });
      // }

      // if (lpTag.identities.indexOf(identityFn) < 0) {
      //   lpTag.identities.push(identityFn);
      // } else {
      //   let tmpIdx = lpTag.identities.indexOf(identityFn)
      //   lpTag.identities[tmpIdx] = identityFn
      // }


      window.lpTag.section = [ "test-auth" ];

      var getData = (getDataSetting) => {
        return $.ajax(getDataSetting)    
      }

      var bearerToken = "";
      var testFn = async () => {
        try {
          
          var bearerSettings = {
            "url": "https://dev-xp3j4tvq.auth0.com/oauth/token",// Token Endpoint
            "method": "POST",
            "timeout": 0,
            "headers": {
              "Content-Type": "application/json"
            },
            "data": JSON.stringify({"grant_type":"client_credentials","client_id":"l6EYVwVr2Doauy0ixv6fMHrTeEFwkAGX","client_secret":"FT1AN9frptQTZPHK5Bj2PRVaM3s6lZXfllY1jBRoEm3pjLkl9Vdp-vOmIV__maxT","audience":"https://dev-xp3j4tvq.auth0.com/api/v2/"}),
          };
          const response = await getData(bearerSettings)
          console.log(`Bearer response: ${JSON.stringify(response)}`);
          bearerToken = response.access_token;
          console.log("111")

          var codeSettings = {
            "url": "https://dev-xp3j4tvq.auth0.com/oauth/token",
            "method": "POST",
            "headers": {
              "content-type": "application/x-www-form-urlencoded",
              "authorization": bearerToken
            },
            "data": {"grant_type":"authorization_code","client_id":"l6EYVwVr2Doauy0ixv6fMHrTeEFwkAGX","client_secret":"FT1AN9frptQTZPHK5Bj2PRVaM3s6lZXfllY1jBRoEm3pjLkl9Vdp-vOmIV__maxT","code":code, "redirect_uri": document.location.href}
          }
          const codeResponse = await getData(codeSettings)
          console.log(`response from IDP: ${JSON.stringify(codeResponse)}`);
          idtoken=codeResponse.id_token+'';
          var tempClaims = idtoken.split('.');
          if(!tempClaims.length == 3) {
            console.warn('JWT not valid, perhaps go back to login screen?');
            return;
          } else {
            console.log('looks like a jwt...');
            //console.log(tempClaims[1]);
          }
          var claims = JSON.parse(atob(tempClaims[1]));
        // NOTE: base64 decode brower support here, https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/atob
        
          console.log(claims);
          function identityFn(callback) {
            console.log('inside identityFn');
            //console.log(callback);
            callback({
                iss: claims.iss, 
                acr: "loa1",
                sub: claims.sub //tkn: idtoken
            });
          }
          // lpTag.identities = []
          // lpTag.identities.push(identityFn);
          // lpTag.section = [ "test-auth" ];
          // if (window.lpTag.identities.indexOf(identityFn) < 0) {
          //   window.lpTag.identities.push(identityFn);
          // } else {
          //   let tmpIdx = lpTag.identities.indexOf(identityFn)
          //   window.lpTag.identities[tmpIdx] = identityFn
          // }

          window.lpTag.identities.push(identityFn);

          console.log("before lptag start");
          lpTag.start()
          //xxx();
          
        } 
        catch(err) {
          console.log(err);
        }
      }

      testFn();
      var xxx = ()=> {
        console.log("xxxx")
        // lpTag.start()
        //setTimeout(window.lpTag.start(), 5000);
      }

      console.log("222")

      var settings = {
        "url": "https://dev-xp3j4tvq.auth0.com/oauth/token",
        "method": "POST",
        "headers": {
          "content-type": "application/x-www-form-urlencoded",
          "authorization": bearerToken
        },
        "data": {"grant_type":"authorization_code","client_id":"l6EYVwVr2Doauy0ixv6fMHrTeEFwkAGX","client_secret":"FT1AN9frptQTZPHK5Bj2PRVaM3s6lZXfllY1jBRoEm3pjLkl9Vdp-vOmIV__maxT","code":code, "redirect_uri": document.location.href}
      }

      // $.ajax(settings)
      // .error((resErr)=> {
      //   console.log(`resErr: ${resErr}`)
      // })
      // .done(function (response) {
      //   // for iss and sub values a separate call is made to the IDP and the response is a JWT
      //   console.log("response from IDP: ");
      //   console.log(response);
      //   idtoken=response.id_token+'';
      //   var tempClaims = idtoken.split('.');
      //   if(!tempClaims.length == 3) {
      //     console.warn('JWT not valid, perhaps go back to login screen?');
      //     return;
      //   } else {
      //     console.log('looks like a jwt...');
      //     //console.log(tempClaims[1]);
      //   }
      //   var claims = JSON.parse(atob(tempClaims[1]));
      // // NOTE: base64 decode brower support here, https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/atob
      //   console.log(claims);
      //   function identityFn(callback) {
      //     console.log('inside identityFn');
      //     //console.log(callback);
      //     callback({
      //         iss: claims.iss, 
      //         acr: "loa1",
      //         tkn: idtoken//sub: claims.sub
      //     });
      //   }

      //   if (lpTag.identities.indexOf(identityFn) < 0) {
      //     lpTag.identities.push(identityFn);
      //   } else {
      //     let tmpIdx = lpTag.identities.indexOf(identityFn)
      //     lpTag.identities[tmpIdx] = identityFn
      //   }
      //   // lpTag.identities = []
      //   // lpTag.identities.push(identityFn);
      // });
      
      
      // lpTag.section = [ "test-auth" ];
      //TODO: Make dynamic and pickup section field

      // NOTE: We are pulling apart the JWT here, but for code flow, JWE & in general this is BAD practice.
      // The web portal should know this information VIA an API or other existing means, please read documentation below for further information.
      

      // NOTE: Required for Authenticated web messaging on ALL pages...
      // LP Monitoring: https://developers.liveperson.com/rt-interactions-monitoring-overview.html#terminology
      // RFC: http://openid.net/specs/openid-connect-core-1_0.html#IDToken
      // function identityFn(callback) {
      //     console.log('inside identityFn');
      //     console.log(callback);
      //     callback({
      //         iss: "https://dev-xp3j4tvq.auth0.com/", //"https://abc-izkao4-v.au.lol.com/", //claims.iss, //issuer
      //         acr: "loa1", //
      //         sub: "auth0|601123bd29fe4800694032c1"//"xxxxxxx" //claims.sub //user-id
      //     });
      // }

      // if (lpTag.identities.indexOf(identityFn) < 0) {
      //   lpTag.identities.push(identityFn);
      // } else {
      //   let tmpIdx = lpTag.identities.indexOf(identityFn)
      //   lpTag.identities[tmpIdx] = identityFn
      // }

      // lpTag.sdes.push({
      //     "type": "personal",  //MANDATORY
      //         "personal": {
      //         "firstname": "Johnxx",  // FIRST NAME
      //         "lastname": "Doexx",  // SURNAME
      //         "age": {
      //            "age": 34,  // AGE AS INTEGER
      //            "year": 1980,  // BIRTH YEAR
      //            "month": 4,  // BIRTH MONTH
      //            "day": 15  // BIRTH DAY
      //        },
      //         "contacts": [{
      //            "email": "myname@example.com",  // EMAIL
      //            "phone": "+1 212-788-8877"  // PHONE NUMBER
      //        }],
      //         "gender": "MALE",  // MALE, FEMALE, OTHER
      //         "company": "company \r\n apple"  // VISITOR COMPANY NAME
      //     }
      // });

      
      
      var toLogin = document.getElementById('toLogin');
      toLogin.style.visibility = 'hidden';
      var loggedIn = document.getElementById('loggedIn');
      loggedIn.style.visibility = 'visible';
        
    } else {
      // Need to login and collect Token
      if(document.location.href.indexOf('web-messaging-bank-portal-code.html')) {
        document.location = document.location.href.replace('web-messaging-bank-portal-code.html', 'web-messaging-login-page-code.html');
      }
    }

    lpTag.site = $.cookie('lpSite') ||  lpTag.site;
    if(lpTag.site !== undefined && lpTag.site !== '') {
      document.getElementById("accountId").value = lpTag.site;
      console.log("did i get the right site id? site id is currently " + lpTag.site);
    }
  });

 </script>
</head>
<body>

 <script type="text/javascript">
lpTag.sdes = lpTag.sdes||[];  //Always include the declaration of the SDE's array.

lpTag.identities = lpTag.identities||[]; // NOTE: Required for authenticated web messaging or earlier.

lpTag.autoStart = false;
</script>
<div id="loginBox">
    <p><img src="livebank-logo.png"></img></p>
    <div id="toLogin">
        <p>Account ID :</p>
        <input type="text" id="accountId"></input>
        <!--<p>Section:</p>
        <input type="text" id="sectionId"></input>-->
    </div?>
    <div id="loggedIn">
        <center>
            <img src="padlock.png"></img>
            <p>Logged in</p>
            <input id="loginButton" type="button" value="Logout" onclick="lpLogoutUser();"><br />
            <div>
              <p>ID Token /Code</p>
              <TextArea id="idToken"></TextArea>
            </div>
        </center>
    </div>
</div>
</body>
</html>