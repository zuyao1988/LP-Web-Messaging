<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- optimized meta tag -->
  <meta name="viewport" content="user-scalable=0, width=device-width, initial-scale=1.0,  minimum-scale=1.0, maximum-scale=1.0">

  <title> LE Tag Code Pack - Web Messaging</title>
  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- le-mtagconfig.js must be called from every page. Please update src to match account ID accordingly -->
  <!-- BEGIN LivePerson Monitor. -->
  <script type="text/javascript" src="le-mtagconfig.js"></script>
  <!-- END LivePerson Monitor. -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

  <script type="text/javascript">
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),results = regex.exec(url);
      if (!results)
        return null;
      if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

   var cnf = {
      redirectURI: document.location.href,
      authURI: "", // Authorisation endpoint
      clientID: "",
      grantType: "authorization_code", // How access will be granted
      nonce: "LiveEngage",
      scope: "openid", // What information to pass - LiveEngage can process standard claims & custom claims under parent lp_sdes. See https://developers.liveperson.com/mobile-sdk-and-web-authentication-detailed-api.html#openid-token-structure
      responseType: "code" // Code flow
    };

    var code = getParameterByName('code');
    console.log("code   : " + code);

    window.lpGetAuthenticationToken = function (callback) {
      if(typeof code === 'undefined' || code === null){
          console.log('code undefined');

          if(document.location.href.indexOf('web-messaging-member-portal.html')) {
            document.location = document.location.href.replace('web-messaging-member-portal.html', 'web-messaging-login-page.html');
          }
      } else {
        console.log("Got notification from the cb redirect tab: " + code);
        var payload = {
          ssoKey: code, // code (AuthKey) in Code Flow
          redirect_uri: "http://localhost:8002/code/web-messaging-member-portalomgg.html" + document.location.search
        };

        console.log('payload: ' + JSON.stringify(payload));
        var error;
        if(error !== undefined) {
            console.log("error undefined");
            callback(payload, error);
        } else {
            console.log("no error");
            callback(payload);
        }
      }
    };

    window.lpLogoutUser = function() {
      document.location = document.location.href.replace('web-messaging-member-portal.html', 'web-messaging-login-page.html');
    };

    // function identityFn(callback) {
    //   console.log('inside identityFn');
    //   console.log('callback: ' + callback);
    //   callback({
    //     iss: "https://abc-izkao4-v.au.lol.com/", // Brand issuer claim
    //     acr: "loa1",
    //     sub: "auth0|5fa21a1e7c07e60069f23382" //"auth0|5f48bf4f0bf8540067472538" // Subject claim ID for customer
    //   });
    // };

 // Start Tag or not...
 $(document).ready(function() {
    if(typeof code !== 'undefined' && code !== null){
      console.log("have code");
      document.getElementById("idToken").value = code;

      console.log("code: " + code);


      // This function tells LP monitoring the person is a known consumer from brand point of view (which is verified with idp),
      // allowing authenticated engagements to be presented to the consumer
      // function identityFn(consumerclaim, callback) {
      //   let {iss, sub} = consumerclaim;
      //   console.log('inside identityFn ' + iss + '||' + sub + JSON.stringify(consumerclaim));
      //   console.log('callback: ' + callback);
      //   return function() {
      //     callback({
      //       iss: iss, // Brand issuer claim
      //       acr: "loa1",
      //       sub: sub //"auth0|5f48bf4f0bf8540067472538" // Subject claim ID for customer
      //     })
      //   }
      // }

      
      //lpTag.identities = [];      
      //lpTag.identities.push(identityFn);

      var settings = {
        "url": "https://dev-izkao4-v.au.auth0.com/oauth/token",// Token Endpoint
        "method": "POST",
        "timeout": 0,
        "headers": {
          "Content-Type": "application/json"
        },
        "data": JSON.stringify({"grant_type":"client_credentials","client_id":"9QGDzw0SnsUs4jRK3hBjNs1aEBpxncWY","client_secret":"9ztOiiAOGk0S-3j27wDKaWgqsyh2AfZu8zFvk2tvf1w-ucluKmqMUzhltslXJBWQ","audience":"https://dev-izkao4-v.au.auth0.com/api/v2/"}),
      };

      var getData = (getDataSetting) => {
        return $.ajax(getDataSetting)    
      }

      var testFn = async () => {
        try {
          const response = await getData(settings)
          console.log(response)
            
          // for iss and sub values a separate call is made to the IDP and the response is a JWT
          console.log("response from IDP: ");
          console.log(response);
          idtoken=response.access_token+'';
          var tempClaims = idtoken.split('.');
          if(!tempClaims.length == 3) {
            console.warn('JWT not valid, perhaps go back to login screen?');
            return;
          } else {
            console.log('looks like a jwt...');
            //console.log(tempClaims[1]);
          }

          var claims = JSON.parse(atob(tempClaims[1]));
          // NOTE: base64 decode brower support here, https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/atob
          console.log(claims);
            
          // function identityFn(callback) {
          //   console.log('inside identityFn');
          //   //console.log(callback);
          //   callback({
          //       iss: "https://dev-izkao4-v.au.auth0.com/", //claims.iss, 
          //       acr: "loa1",
          //       sub: "9QGDzw0SnsUs4jRK3hBjNs1aEBpxncWY@clients" //claims.sub
          //   });
          // }
          console.log(lpTag.section);
          console.log('claims.sub: ' + claims.sub);

          function identityFn(callback) {
            console.log('inside identityFn');
            //console.log(callback);
            callback({
                iss: claims.iss, 
                acr: "loa1",
                sub: claims.sub
            });
          }
          console.log(identityFn)
          console.log(lpTag)
          // lpTag.identities = [];
          lpTag.identities.push(identityFn);

          lpTag.section = [ "test-auth" ];

          //lpTag.section = [ "test-auth" ];

        } catch(err) {
          console.log(err);
        }
      }

      // $.ajax(settings).done(function (response) {
      //   // for iss and sub values a separate call is made to the IDP and the response is a JWT
      //   console.log("response from IDP: ");
      //   console.log(response);
      //   idtoken=response.access_token+'';
      //   var tempClaims = idtoken.split('.');
      //   if(!tempClaims.length == 3) {
      //     console.warn('JWT not valid, perhaps go back to login screen?');
      //     return;
      //   } else {
      //     console.log('looks like a jwt...');
      //     //console.log(tempClaims[1]);
      //   }
      //   var claims = JSON.parse(atob(tempClaims[1]));
      // // NOTE: base64 decode brower support here, https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/atob
      //   console.log(claims);
      //   function identityFn(callback) {
      //     console.log('inside identityFn');
      //     //console.log(callback);
      //     callback({
      //         iss: claims.iss, 
      //         acr: "loa1",
      //         sub: claims.sub
      //     });
      //   }

      //   lpTag.identities = [];
      //   lpTag.identities.push(identityFn);
      // });

      
      lpTag.section = [ "test-auth" ];
      // NOTE: Required for Authenticated web messaging on ALL pages...
      // LP Monitoring: https://developers.liveperson.com/rt-interactions-monitoring-overview.html#terminology
      // RFC: http://openid.net/specs/openid-connect-core-1_0.html#IDToken
      function identityFn(callback) {
          console.log('inside identityFn');
          console.log(callback);
          callback({
              iss: claims.iss, //issuer
              acr: "loa1", //
              sub: claims.sub //user-id
          });
      }
      lpTag.identities.push(identityFn);
      
      testFn();

      var toLogin = document.getElementById('toLogin');
      toLogin.style.visibility = 'hidden';
      var loggedIn = document.getElementById('loggedIn');
      loggedIn.style.visibility = 'visible';
    } else {
      // Need to login and collect Token
      if(document.location.href.indexOf('web-messaging-member-portal.html')) {
        document.location = document.location.href.replace('web-messaging-member-portal.html', 'web-messaging-login-page.html');
      }
    }

    if(lpTag.site !== undefined && lpTag.site !== '') {
      document.getElementById("accountId").value = lpTag.site;
      console.log("did i get the right site id? site id is currently " + lpTag.site);
    };
  });

 </script>
</head>
<body>

<script type="text/javascript">
  lpTag.sdes = lpTag.sdes||[];  //Always include the declaration of the SDE's array.
  lpTag.identities = lpTag.identities||[]; // NOTE: Required for authenticated web messaging or earlier.
</script>

<div id="loginBox">
    <p><img src="logo.png"></img></p>
    <div id="toLogin">
        <p>Account ID:</p>
        <input type="text" id="accountId"></input>
    </div?>
    <div id="loggedIn">
        <center>
            <img src="padlock.png"></img>
            <p>Logged in</p>
            <input id="loginButton" type="button" value="Logout" onclick="lpLogoutUser();"><br />
            <div>
              <p>ID Token / Code</p>
              <TextArea id="idToken"></TextArea>
            </div>
        </center>
    </div>
</div>
</body>
</html>
